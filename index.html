<!DOCTYPE html>




<html class="theme-next pisces" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Zipei Feng&#39;s notes">
<meta property="og:url" content="https://fengzipei.github.io/index.html">
<meta property="og:site_name" content="Zipei Feng&#39;s notes">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zipei Feng&#39;s notes">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://fengzipei.github.io/"/>





  <title>Zipei Feng's notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zipei Feng's notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengzipei.github.io/2018/07/22/Build-ZFS-with-QAT-supported/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zipei Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zipei Feng's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/22/Build-ZFS-with-QAT-supported/" itemprop="url">Build_ZFS_with_QAT_supported</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-22T20:21:32+08:00">
                2018-07-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Build-ZFS-with-QAT-supported"><a href="#Build-ZFS-with-QAT-supported" class="headerlink" title="Build ZFS with QAT supported"></a>Build ZFS with QAT supported</h1><h2 id="0-System-environment"><a href="#0-System-environment" class="headerlink" title="0. System environment"></a>0. System environment</h2><blockquote>
<p>OS: Ubuntu 16.04 LTS</p>
<p>Kernel: linux 4.4.1</p>
<p>QAT hardware: DH895XCC</p>
<p>QAT driver: qatmux.l.2.6.0-60</p>
<p>ZFS: 0.7.0</p>
</blockquote>
<h2 id="1-Build-amp-install-QAT-driver"><a href="#1-Build-amp-install-QAT-driver" class="headerlink" title="1. Build &amp; install QAT driver"></a>1. Build &amp; install QAT driver</h2><ol>
<li><p>Download QAT driver from intel:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://01.org/sites/default/files/page/qatmux.l.2.6.0-60.tgz</span><br></pre></td></tr></table></figure>
<p>Note: I tried to install <a href="https://01.org/sites/default/files/downloads/intelr-quickassist-technology/qat1.7.l.4.2.0-00012.tar.gz" target="_blank" rel="noopener">qat1.7</a> and qat1.6, but I failed.</p>
</li>
<li><p>Create a directory and extract driver to here:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir QAT</span><br><span class="line">cd QAT</span><br><span class="line">tar zxvf ../qatmux.l.2.6.0-60.tgz</span><br></pre></td></tr></table></figure>
</li>
<li><p>There are some places need to modify:</p>
<ol>
<li><p>QAT1.6/quickassist/utilities/osal/src/linux/user_space/OsalCryptoInterface.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">77</span> OSAL_STATUS</span><br><span class="line"><span class="number">78</span> osalHashSHA1(UINT8 *in, UINT8 *out)</span><br><span class="line"><span class="number">79</span> &#123;</span><br><span class="line"><span class="number">80</span>     SHA_CTX ctx;</span><br><span class="line"><span class="number">81</span>     <span class="keyword">if</span>(!SHA_Init(&amp;ctx))</span><br><span class="line"><span class="number">82</span>     &#123;</span><br><span class="line"><span class="number">83</span>         <span class="keyword">return</span> OSAL_FAIL;</span><br><span class="line"><span class="number">84</span>     &#125;</span><br><span class="line"><span class="number">85</span>     SHA1_Transform(&amp;ctx, in);</span><br><span class="line"><span class="number">86</span>     <span class="built_in">memcpy</span>(out, &amp;ctx, SHA_DIGEST_LENGTH);</span><br><span class="line"><span class="number">87</span>     <span class="keyword">return</span> OSAL_SUCCESS;</span><br><span class="line"><span class="number">88</span> &#125;</span><br></pre></td></tr></table></figure>
<p>change SHA_INIT to SHA1_INIT.</p>
</li>
<li><p>QAT1.6/quickassist/adf/drivers/common/linux/src/adf_proc_debug.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">adf_debug_show</span><span class="params">(struct seq_file *sfile, <span class="keyword">void</span> *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">debug_file_info_t</span>* file_info = sfile-&gt;<span class="keyword">private</span>;</span><br><span class="line">        <span class="keyword">if</span> (file_info &amp;&amp; file_info-&gt;seq_read &amp;&amp; file_info-&gt;page) &#123;</span><br><span class="line">                <span class="keyword">int</span> ret = <span class="number">0</span>, old_offset = file_info-&gt;offset;</span><br><span class="line">                file_info-&gt;offset =</span><br><span class="line">                                   file_info-&gt;seq_read(file_info-&gt;private_data,</span><br><span class="line">                                   file_info-&gt;page, PAGE_SIZE - <span class="number">1</span>,</span><br><span class="line">                                   file_info-&gt;offset);</span><br><span class="line">                <span class="comment">// ret = seq_puts(sfile, (char*)file_info-&gt;page);</span></span><br><span class="line">                seq_puts(sfile, (<span class="keyword">char</span>*)file_info-&gt;page);</span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                        <span class="comment">/* run out of space - need to reprint */</span></span><br><span class="line">                        file_info-&gt;offset = old_offset;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>remove<code>ret</code>.</p>
</li>
<li><p>QAT1.6/quickassist/adf/user/user_proxy/src/adf_user_ETring_mgr_dp.c:</p>
<p>Remove <code>INLINE</code> before these functions:</p>
<ul>
<li><p><code>icp_adf_getQueueNext</code></p>
</li>
<li><p><code>icp_adf_getSingleQueueAddr</code></p>
</li>
<li><p><code>icp_adf_updateQueueTail</code></p>
</li>
<li><p><code>icp_adf_pollQueue</code></p>
</li>
<li><p><code>icp_adf_queueDataToSend</code></p>
</li>
<li><p><code>icp_adf_getQueueMemory</code></p>
</li>
</ul>
</li>
</ol>
</li>
<li><p>Enter root mode:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run installer:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./installer</span><br></pre></td></tr></table></figure>
<p>choose build then install.</p>
</li>
<li><p>Put in-tree qat modules to blacklist by add following items to <code>/etc/modprobe.d/blacklist.conf</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">blacklist qat_dh895xcc</span><br><span class="line"></span><br><span class="line">blacklist intel_qat</span><br><span class="line"></span><br><span class="line">blacklist usdm_drv</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="2-Build-amp-install-ZFS"><a href="#2-Build-amp-install-ZFS" class="headerlink" title="2. Build &amp; install ZFS"></a>2. Build &amp; install ZFS</h2><ol>
<li><p>Get spl source code from github:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zfsonlinux/spl</span><br></pre></td></tr></table></figure>
</li>
<li><p>Compile spl code:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd spl</span><br><span class="line">git checkout master</span><br><span class="line">sh autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make -s -j$(nproc)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Get zfs source code from github:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zfsonlinux/zfs</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Optional:</strong> To verify it is QAT that take effects, add some <code>printk</code> to zfs source code:</p>
<p>module/zfs/qat_compress.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qat_compress(<span class="keyword">qat_compress_dir_t</span> dir, <span class="keyword">char</span> *src, <span class="keyword">int</span> src_len,</span><br><span class="line">    <span class="keyword">char</span> *dst, <span class="keyword">int</span> dst_len, <span class="keyword">size_t</span> *c_len)</span><br><span class="line">&#123;</span><br><span class="line">        printk(<span class="string">"calling qat_compress...\n"</span>);</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Compile and install zfs:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> ../zfs</span><br><span class="line">git checkout master</span><br><span class="line"><span class="keyword">sh</span> autogen.<span class="keyword">sh</span></span><br><span class="line">./configure --with-qat=&lt;parent directory of QAT <span class="keyword">source</span>&gt;/QAT/QAT1.<span class="number">6</span></span><br><span class="line"><span class="keyword">make</span> -s -<span class="keyword">j</span>$(nproc)</span><br><span class="line"><span class="keyword">make</span> install</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="3-Verify-ZFS-amp-QAT"><a href="#3-Verify-ZFS-amp-QAT" class="headerlink" title="3. Verify ZFS &amp; QAT"></a>3. Verify ZFS &amp; QAT</h2><ol>
<li><p>Simulate a disk with file:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/zero of=zfs_disk bs=1M count=4096</span><br><span class="line">losetup /dev/loop0 zfs_disk</span><br><span class="line"><span class="meta">#</span><span class="bash"> verify zfs status</span></span><br><span class="line">zpool status</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> compression <span class="keyword">for</span> zfs_test</span></span><br><span class="line">zfs set compression=gzip zfs_test</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create a pool:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool create zfs_test /dev/loop0</span><br><span class="line">zpool status</span><br></pre></td></tr></table></figure>
</li>
<li><p>Set compression for zfs_test:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs set compression=gzip zfs_test</span><br></pre></td></tr></table></figure>
</li>
<li><p>Verify zfs_test parameters:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs get all</span><br></pre></td></tr></table></figure>
</li>
<li><p>Write something to zfs_test to verify QAT is working:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp qatmux.l.2.6.0-60.tgz /zfs_test</span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong> We should not verify by writing zero to zfs_test, because zfs will check this situation and handle it directly without calling compression function. So, don’t run something like this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/zero of=a bs=1M count=1024</span><br></pre></td></tr></table></figure>
</li>
<li><p>If everything is OK, you will see “calling qat_compress…” in dmesg output.</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengzipei.github.io/2018/07/18/compile_filesystem_as_module/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zipei Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zipei Feng's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/18/compile_filesystem_as_module/" itemprop="url">Compile filesystem as module</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-18T18:23:03+08:00">
                2018-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Compile-filesystem-as-module"><a href="#Compile-filesystem-as-module" class="headerlink" title="Compile filesystem as module"></a>Compile filesystem as module</h1><h2 id="1-Purpose"><a href="#1-Purpose" class="headerlink" title="1. Purpose"></a>1. Purpose</h2><p>To avoid rebooting in filesystem development.</p>
<h2 id="2-Environment"><a href="#2-Environment" class="headerlink" title="2. Environment"></a>2. Environment</h2><p>OS: Ubuntu 16.04.4 LTS</p>
<p>Kernel: 4.4.1</p>
<p>Target filesystem: EXT2</p>
<h2 id="3-Procedure"><a href="#3-Procedure" class="headerlink" title="3. Procedure"></a>3. Procedure</h2><ol>
<li><p>Run <code>make menuconfig</code>, mark EXT2 as module:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;M&gt;</span> <span class="attribute">Second</span> extended fs support</span><br></pre></td></tr></table></figure>
<p>save this configuration.</p>
</li>
<li><p>Compile &amp;&amp; install kernel:</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> -j$(nproc)</span><br><span class="line"><span class="built_in">make</span> modules_install</span><br><span class="line"><span class="built_in">make</span> install</span><br></pre></td></tr></table></figure>
<p>reboot and choose this kernel in grub.</p>
</li>
<li><p>Create a directory called ‘modulefs’, and copy EXT2 source files to it:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> ~</span><br><span class="line"><span class="built_in">mkdir</span> modulefs</span><br><span class="line"><span class="keyword">cp</span> -r <span class="symbol">&lt;kernel_directory&gt;</span>/fs/ext2 modulefs</span><br></pre></td></tr></table></figure>
</li>
<li><p>Modify <code>Makefile</code> of EXT2, here is the <code>diff</code> result:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">5c5</span><br><span class="line">&lt; obj-$(CONFIG_EXT2_FS) += ext2.o</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">&gt; obj-m += ext2.o</span><br><span class="line">9a10,12</span><br><span class="line">&gt; KERNELDIR:=/home/feng/btrfs-test/linux-4.4.1/</span><br><span class="line">&gt; PWD:=$(shell pwd)</span><br><span class="line">&gt;</span><br><span class="line">12a16,20</span><br><span class="line">&gt;</span><br><span class="line">&gt; default:</span><br><span class="line">&gt;       make -C $(KERNELDIR) M=$(PWD) modules</span><br><span class="line">&gt; clean:</span><br><span class="line">&gt;       rm -rf *.o *.mod.c *.ko *.symvers</span><br></pre></td></tr></table></figure>
<p><strong>Replace </strong> <em>KERNELDIR</em> path with your kernel path.</p>
</li>
<li><p>In ~/modulefs/ext2/, compile EXT2:</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> clean</span><br><span class="line"><span class="built_in">make</span> -j$(nproc)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Remove EXT2 module in system:</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">modprobe <span class="keyword">ext2</span></span><br><span class="line"><span class="keyword">rmmod </span><span class="keyword">ext2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Insert our EXT2 module into system:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">insmod</span> <span class="selector-tag">ext2</span><span class="selector-class">.ko</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Add some <code>printk</code> in EXT2 source code to make sure verify this module.</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengzipei.github.io/2018/05/30/hadoop-cluster-setup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zipei Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zipei Feng's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/hadoop-cluster-setup/" itemprop="url">hadoop cluster setup</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-30T19:38:56+08:00">
                2018-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="搭建-Hadoop-集群过程记录"><a href="#搭建-Hadoop-集群过程记录" class="headerlink" title="搭建 Hadoop 集群过程记录"></a>搭建 Hadoop 集群过程记录</h1><blockquote>
<p>开发环境：Ubuntu 16.04 server</p>
<p>Hadoop 版本：Apache Hadoop 3.0.0-alpha4</p>
<p>openjdk 版本：1.8.0_131</p>
</blockquote>
<h2 id="单节点模式（Local-Mode）"><a href="#单节点模式（Local-Mode）" class="headerlink" title="单节点模式（Local Mode）"></a>单节点模式（Local Mode）</h2><ol>
<li><p>安装 ssh：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ssh</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载 Hadoop 软件，并解压：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirror.metrocast.net/apache/hadoop/common/hadoop-3.0.0-alpha4/hadoop-3.0.0-alpha4.tar.gz</span><br><span class="line">tar xvf hadoop-3.0.0-alpha4/hadoop-3.0.0-alpha4.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 Hadoop 中 Java 的路径（<code>etc/hadoop/hadoop-env.sh</code>）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=<span class="built_in">export</span> JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64/jre</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备输入文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir input</span><br><span class="line">cp etc/hadoop/*.xml input</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 Hadoop 自带的数单词个数的程序测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-3.0.0-alpha4.jar wordcount input output</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看输出结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat output/*</span><br></pre></td></tr></table></figure>
<p>实验结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&quot;*&quot;	18</span><br><span class="line">&quot;AS	9</span><br><span class="line">&quot;License&quot;);	9</span><br><span class="line">&quot;alice,bob	18</span><br><span class="line">&quot;clumping&quot;	1</span><br><span class="line">(ASF)	1</span><br><span class="line">(root	1</span><br><span class="line">(the	9</span><br><span class="line">--&gt;	18</span><br><span class="line">-1	1</span><br><span class="line">0.0	1</span><br><span class="line">1-MAX_INT.	1</span><br><span class="line">1.	1</span><br><span class="line">1.0.	1</span><br><span class="line">2.0	9</span><br><span class="line">40	2</span><br><span class="line">40+20=60	1</span><br><span class="line">&lt;!--	18</span><br><span class="line">&lt;/configuration&gt;	9</span><br><span class="line">&lt;/description&gt;	29</span><br><span class="line">&lt;/property&gt;	50</span><br><span class="line">&lt;?xml	8</span><br><span class="line">&lt;?xml-stylesheet	4</span><br><span class="line">&lt;configuration&gt;	9</span><br><span class="line">&lt;description&gt;	28</span><br><span class="line">&lt;description&gt;ACL	21</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="伪集群模式（Pseudo-Distributed-Mode）"><a href="#伪集群模式（Pseudo-Distributed-Mode）" class="headerlink" title="伪集群模式（Pseudo-Distributed Mode）"></a>伪集群模式（Pseudo-Distributed Mode）</h2><p>在单节点模式的基础上进行下面的操作：</p>
<ol>
<li><p>配置 <code>etc/hadoop/core-site.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://localhost:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 <code>etc/hadoop/hdfs-site.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 ssh 免密码登录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试 ssh 免密码登录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh localhost</span><br></pre></td></tr></table></figure>
<p>若没有提示输入密码，则配置成功。</p>
</li>
<li><p>格式化 namenode：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/hdfs namenode -format</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 namenode 和 datanode：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sbin/start-dfs.sh</span><br></pre></td></tr></table></figure>
<p>成功后可以通过 <code>http://localhost:9870/</code> 访问 namenode 的 web 界面。</p>
</li>
<li><p>创建 hdfs 中的目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bin/hdfs dfs -mkdir /user</span><br><span class="line">bin/hdfs dfs -mkdir /user/f</span><br></pre></td></tr></table></figure>
</li>
<li><p>将输入文件到分布式文件系统中去：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bin/hdfs dfs -mkdir input</span><br><span class="line">bin/hdfs dfs -put etc/hadoop/*.xml input</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 Hadoop 自带的数单词个数的程序测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-3.0.0-alpha4.jar wordcount input output</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看输出结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/hdfs dfs -cat output/*</span><br></pre></td></tr></table></figure>
<p>实验结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&quot;*&quot;	18</span><br><span class="line">&quot;AS	9</span><br><span class="line">&quot;License&quot;);	9</span><br><span class="line">&quot;alice,bob	18</span><br><span class="line">&quot;clumping&quot;	1</span><br><span class="line">(ASF)	1</span><br><span class="line">(root	1</span><br><span class="line">(the	9</span><br><span class="line">--&gt;	18</span><br><span class="line">-1	1</span><br><span class="line">0.0	1</span><br><span class="line">1-MAX_INT.	1</span><br><span class="line">1.	1</span><br><span class="line">1.0.	1</span><br><span class="line">2.0	9</span><br><span class="line">40	2</span><br><span class="line">40+20=60	1</span><br><span class="line">&lt;!--	18</span><br><span class="line">&lt;/configuration&gt;	9</span><br><span class="line">&lt;/description&gt;	29</span><br><span class="line">&lt;/property&gt;	50</span><br><span class="line">&lt;?xml	8</span><br><span class="line">&lt;?xml-stylesheet	4</span><br><span class="line">&lt;configuration&gt;	9</span><br><span class="line">&lt;description&gt;	28</span><br><span class="line">&lt;description&gt;ACL	21</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭分布式文件系统：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sbin/stop-dfs.sh</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="集群模式（Fully-Distributed-Mode）"><a href="#集群模式（Fully-Distributed-Mode）" class="headerlink" title="集群模式（Fully-Distributed Mode）"></a>集群模式（Fully-Distributed Mode）</h2><blockquote>
<p>这个实验是在几台不同的主机上进行的，为此我们创建了三台虚拟机（master, slave, slave2）。</p>
</blockquote>
<ol>
<li><p>安装好两台 slave 节点的系统。</p>
</li>
<li><p>在 master 节点进行 3 - 8 步的配置。</p>
</li>
<li><p>获取几台主机的 ip 地址，修改 <code>/etc/hosts</code> 文件，方便识别各个主机:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1	localhost</span><br><span class="line">127.0.1.1	ubuntu</span><br><span class="line">192.168.124.129 slave</span><br><span class="line">192.168.124.130 slave2</span><br><span class="line">192.168.124.128 master</span><br><span class="line"></span><br><span class="line"># The following lines are desirable for IPv6 capable hosts</span><br><span class="line">::1     localhost ip6-localhost ip6-loopback</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>core-site.xml</code> :</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.default.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>hdfs-site.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>yarn-site.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">true<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.resource-tracker.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">true<span class="tag">&lt;<span class="name">value</span>&gt;</span>master:8025<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">true<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.scheduler.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">true<span class="tag">&lt;<span class="name">value</span>&gt;</span>master:8035<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">true<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">true<span class="tag">&lt;<span class="name">value</span>&gt;</span>master:8050<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>mapred-site.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">true<span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.job.tracker<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">true<span class="tag">&lt;<span class="name">value</span>&gt;</span>master:5431<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">true<span class="tag">&lt;<span class="name">name</span>&gt;</span>mapred.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">true<span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>workers</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">master</span><br><span class="line">slave</span><br><span class="line">slave2</span><br></pre></td></tr></table></figure>
</li>
<li><p>同之前两种模式一样，配置 master, slave, slave2 的 ssh ，使它们能够两两之间免密码登录。</p>
</li>
<li><p>使用 scp 将 master 节点的 Hadoop 文件夹拷贝到 slave, slave2 的对应位置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r /usr/<span class="built_in">local</span>/hadoop f@slave:/usr/<span class="built_in">local</span></span><br><span class="line">scp -r /usr/<span class="built_in">local</span>/hadoop f@slave2:/usr/<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>停止 dfs，并重新格式化 namenode：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/hadoop/bin/hdfs namenode -format</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 hdfs：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/hadoop/sbin/start-dfs.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 yarn:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/hadoop/sbin/start-yarn.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 master 节点运行 <code>jps</code>，得到输出结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">f@ubuntu:~$ jps</span><br><span class="line">2357 ResourceManager</span><br><span class="line">7511 Jps</span><br><span class="line">2667 NodeManager</span><br><span class="line">1772 NameNode</span><br><span class="line">2110 SecondaryNameNode</span><br><span class="line">1903 DataNode</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 slave 节点运行 <code>jps</code>，得到输出结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f@ubuntu:~$ jps</span><br><span class="line">2244 Jps</span><br><span class="line">1288 NodeManager</span><br><span class="line">1164 DataNode</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 slave2 节点运行 <code>jps</code>，得到输出结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f@ubuntu:~$ jps</span><br><span class="line">1291 NodeManager</span><br><span class="line">1167 DataNode</span><br><span class="line">4015 Jps</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 master 节点运行 <code>/usr/local/hadoop/bin/hdfs dfsadmin -report</code>，得到输出结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">f@ubuntu:~$ /usr/<span class="built_in">local</span>/hadoop/bin/hdfs dfsadmin -report</span><br><span class="line">Configured Capacity: 76822855680 (71.55 GB)</span><br><span class="line">Present Capacity: 45398016000 (42.28 GB)</span><br><span class="line">DFS Remaining: 45397708800 (42.28 GB)</span><br><span class="line">DFS Used: 307200 (300 KB)</span><br><span class="line">DFS Used%: 0.00%</span><br><span class="line">Under replicated blocks: 0</span><br><span class="line">Blocks with corrupt replicas: 0</span><br><span class="line">Missing blocks: 0</span><br><span class="line">Missing blocks (with replication factor 1): 0</span><br><span class="line">Pending deletion blocks: 0</span><br><span class="line"></span><br><span class="line">-------------------------------------------------</span><br><span class="line">Live datanodes (3):</span><br><span class="line"></span><br><span class="line">Name: 192.168.124.128:9866 (master)</span><br><span class="line">Hostname: ubuntu</span><br><span class="line">Decommission Status : Normal</span><br><span class="line">Configured Capacity: 39043194880 (36.36 GB)</span><br><span class="line">DFS Used: 106794 (104.29 KB)</span><br><span class="line">Non DFS Used: 20659420886 (19.24 GB)</span><br><span class="line">DFS Remaining: 16376745984 (15.25 GB)</span><br><span class="line">DFS Used%: 0.00%</span><br><span class="line">DFS Remaining%: 41.95%</span><br><span class="line">Configured Cache Capacity: 0 (0 B)</span><br><span class="line">Cache Used: 0 (0 B)</span><br><span class="line">Cache Remaining: 0 (0 B)</span><br><span class="line">Cache Used%: 100.00%</span><br><span class="line">Cache Remaining%: 0.00%</span><br><span class="line">Xceivers: 1</span><br><span class="line">Last contact: Sun Sep 24 06:23:22 PDT 2017</span><br><span class="line">Last Block Report: Sun Sep 24 04:41:17 PDT 2017</span><br><span class="line"></span><br><span class="line">Name: 192.168.124.129:9866 (slave)</span><br><span class="line">Hostname: ubuntu</span><br><span class="line">Decommission Status : Normal</span><br><span class="line">Configured Capacity: 18889830400 (17.59 GB)</span><br><span class="line">DFS Used: 73728 (72 KB)</span><br><span class="line">Non DFS Used: 3396104192 (3.16 GB)</span><br><span class="line">DFS Remaining: 14510510080 (13.51 GB)</span><br><span class="line">DFS Used%: 0.00%</span><br><span class="line">DFS Remaining%: 76.82%</span><br><span class="line">Configured Cache Capacity: 0 (0 B)</span><br><span class="line">Cache Used: 0 (0 B)</span><br><span class="line">Cache Remaining: 0 (0 B)</span><br><span class="line">Cache Used%: 100.00%</span><br><span class="line">Cache Remaining%: 0.00%</span><br><span class="line">Xceivers: 1</span><br><span class="line">Last contact: Sun Sep 24 06:23:22 PDT 2017</span><br><span class="line">Last Block Report: Sun Sep 24 06:21:10 PDT 2017</span><br><span class="line"></span><br><span class="line">Name: 192.168.124.130:9866 (slave2)</span><br><span class="line">Hostname: ubuntu</span><br><span class="line">Decommission Status : Normal</span><br><span class="line">Configured Capacity: 18889830400 (17.59 GB)</span><br><span class="line">DFS Used: 126678 (123.71 KB)</span><br><span class="line">Non DFS Used: 3396108586 (3.16 GB)</span><br><span class="line">DFS Remaining: 14510452736 (13.51 GB)</span><br><span class="line">DFS Used%: 0.00%</span><br><span class="line">DFS Remaining%: 76.82%</span><br><span class="line">Configured Cache Capacity: 0 (0 B)</span><br><span class="line">Cache Used: 0 (0 B)</span><br><span class="line">Cache Remaining: 0 (0 B)</span><br><span class="line">Cache Used%: 100.00%</span><br><span class="line">Cache Remaining%: 0.00%</span><br><span class="line">Xceivers: 1</span><br><span class="line">Last contact: Sun Sep 24 06:23:22 PDT 2017</span><br><span class="line">Last Block Report: Sun Sep 24 06:21:07 PDT 2017</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 hdfs 中的目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f@ubuntu:~$ /usr/<span class="built_in">local</span>/hadoop/bin/hdfs dfs -mkdir /user</span><br><span class="line">f@ubuntu:~$ /usr/<span class="built_in">local</span>/hadoop/bin/hdfs dfs -mkdir /user/f</span><br></pre></td></tr></table></figure>
</li>
<li><p>将输入文件到分布式文件系统中去：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f@ubuntu:~$ /usr/<span class="built_in">local</span>/hadoop/bin/hdfs dfs -mkdir input</span><br><span class="line">f@ubuntu:~$ /usr/<span class="built_in">local</span>/hadoop/bin/hdfs dfs -put /usr/<span class="built_in">local</span>/hadoop/etc/hadoop/*.xml input</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 master 节点跑一个数单词个数的测试程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f@ubuntu:~$ /usr/<span class="built_in">local</span>/hadoop/bin/hadoop jar /usr/<span class="built_in">local</span>/hadoop/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.0.0-alpha4.jar wordcount input output</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看输出结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f@ubuntu:~$ /usr/<span class="built_in">local</span>/hadoop/bin/hdfs dfs -cat output/*</span><br></pre></td></tr></table></figure>
</li>
<li><p>得到输出结果：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"*"</span>	<span class="number">18</span></span><br><span class="line"><span class="string">"AS	9</span></span><br><span class="line"><span class="string">"</span>License<span class="string">");	9</span></span><br><span class="line"><span class="string">"</span>alice,bob	<span class="number">18</span></span><br><span class="line"><span class="string">"clumping"</span>	<span class="number">1</span></span><br><span class="line">(ASF)	<span class="number">1</span></span><br><span class="line">(root	<span class="number">1</span></span><br><span class="line">(the	<span class="number">9</span></span><br><span class="line">--&gt;	<span class="number">18</span></span><br><span class="line"><span class="number">-1</span>	<span class="number">1</span></span><br><span class="line"><span class="number">0.0</span>	<span class="number">1</span></span><br><span class="line"><span class="number">1</span>-MAX_INT.	<span class="number">1</span></span><br><span class="line"><span class="number">1.</span>	<span class="number">1</span></span><br><span class="line"><span class="number">1.0</span>.	<span class="number">1</span></span><br><span class="line"><span class="number">2.0</span>	<span class="number">9</span></span><br><span class="line"><span class="number">40</span>	<span class="number">2</span></span><br><span class="line"><span class="number">40</span>+<span class="number">20</span>=<span class="number">60</span>	<span class="number">1</span></span><br><span class="line">&lt;!--	<span class="number">18</span></span><br><span class="line">&lt;/configuration&gt;	<span class="number">9</span></span><br><span class="line">&lt;/description&gt;	<span class="number">29</span></span><br><span class="line">&lt;/property&gt;	<span class="number">50</span></span><br><span class="line">&lt;?xml	<span class="number">8</span></span><br><span class="line">&lt;?xml-stylesheet	<span class="number">4</span></span><br><span class="line">&lt;configuration&gt;	<span class="number">9</span></span><br><span class="line">&lt;description&gt;	<span class="number">28</span></span><br><span class="line">&lt;description&gt;ACL	<span class="number">21</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 master 节点访问资源管理器 <code>http://127.0.0.1:8088/cluster/nodes</code>，可以看到所有节点的信息。</p>
</li>
<li><p>在 master 节点访问 namenode 信息<code>http://127.0.0.1:9870/dfshealth.html#tab-overview</code>。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengzipei.github.io/2018/05/30/zlib-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zipei Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zipei Feng's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/zlib-usage/" itemprop="url">zlib usage</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-30T19:35:30+08:00">
                2018-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="zlib-usage"><a href="#zlib-usage" class="headerlink" title="zlib usage"></a>zlib usage</h1><p>以下是zlib的<a href="https://zlib.net/zpipe.c" target="_blank" rel="noopener">官方示例</a>，这里对代码进行一些说明。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* zpipe.c: example of proper use of zlib's inflate() and deflate()</span></span><br><span class="line"><span class="comment">   Not copyrighted -- provided to the public domain</span></span><br><span class="line"><span class="comment">   Version 1.4  11 December 2005  Mark Adler */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Version history:</span></span><br><span class="line"><span class="comment">   1.0  30 Oct 2004  First version</span></span><br><span class="line"><span class="comment">   1.1   8 Nov 2004  Add void casting for unused return values</span></span><br><span class="line"><span class="comment">                     Use switch statement for inflate() return values</span></span><br><span class="line"><span class="comment">   1.2   9 Nov 2004  Add assertions to document zlib guarantees</span></span><br><span class="line"><span class="comment">   1.3   6 Apr 2005  Remove incorrect assertion in inf()</span></span><br><span class="line"><span class="comment">   1.4  11 Dec 2005  Add hack to avoid MSDOS end-of-line conversions</span></span><br><span class="line"><span class="comment">                     Avoid some compiler warnings for input and output buffers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"zlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MSDOS) || defined(OS2) || defined(WIN32) || defined(__CYGWIN__)</span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">include</span> <span class="meta-string">&lt;io.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> SET_BINARY_MODE(file) setmode(fileno(file), O_BINARY)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> SET_BINARY_MODE(file)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHUNK 16384</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Compress from file source to file dest until EOF on source.</span></span><br><span class="line"><span class="comment">   def() returns Z_OK on success, Z_MEM_ERROR if memory could not be</span></span><br><span class="line"><span class="comment">   allocated for processing, Z_STREAM_ERROR if an invalid compression</span></span><br><span class="line"><span class="comment">   level is supplied, Z_VERSION_ERROR if the version of zlib.h and the</span></span><br><span class="line"><span class="comment">   version of the library linked do not match, or Z_ERRNO if there is</span></span><br><span class="line"><span class="comment">   an error reading or writing the files. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">def</span><span class="params">(FILE *source, FILE *dest, <span class="keyword">int</span> level)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret, flush;</span><br><span class="line">    <span class="keyword">unsigned</span> have;</span><br><span class="line">    z_stream strm;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> in[CHUNK];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> out[CHUNK];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* allocate deflate state */</span></span><br><span class="line">    strm.zalloc = Z_NULL;</span><br><span class="line">    strm.zfree = Z_NULL;</span><br><span class="line">    strm.opaque = Z_NULL;</span><br><span class="line">    ret = deflateInit(&amp;strm, level);</span><br><span class="line">    <span class="keyword">if</span> (ret != Z_OK)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* compress until end of file */</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        strm.avail_in = fread(in, <span class="number">1</span>, CHUNK, source);</span><br><span class="line">        <span class="keyword">if</span> (ferror(source)) &#123;</span><br><span class="line">            (<span class="keyword">void</span>)deflateEnd(&amp;strm);</span><br><span class="line">            <span class="keyword">return</span> Z_ERRNO;</span><br><span class="line">        &#125;</span><br><span class="line">        flush = feof(source) ? Z_FINISH : Z_NO_FLUSH;</span><br><span class="line">        strm.next_in = in;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* run deflate() on input until output buffer not full, finish</span></span><br><span class="line"><span class="comment">           compression if all of source has been read in */</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            strm.avail_out = CHUNK;</span><br><span class="line">            strm.next_out = out;</span><br><span class="line">            ret = deflate(&amp;strm, flush);    <span class="comment">/* no bad return value */</span></span><br><span class="line">            assert(ret != Z_STREAM_ERROR);  <span class="comment">/* state not clobbered */</span></span><br><span class="line">            have = CHUNK - strm.avail_out;</span><br><span class="line">            <span class="keyword">if</span> (fwrite(out, <span class="number">1</span>, have, dest) != have || ferror(dest)) &#123;</span><br><span class="line">                (<span class="keyword">void</span>)deflateEnd(&amp;strm);</span><br><span class="line">                <span class="keyword">return</span> Z_ERRNO;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (strm.avail_out == <span class="number">0</span>);</span><br><span class="line">        assert(strm.avail_in == <span class="number">0</span>);     <span class="comment">/* all input will be used */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* done when last data in file processed */</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (flush != Z_FINISH);</span><br><span class="line">    assert(ret == Z_STREAM_END);        <span class="comment">/* stream will be complete */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* clean up and return */</span></span><br><span class="line">    (<span class="keyword">void</span>)deflateEnd(&amp;strm);</span><br><span class="line">    <span class="keyword">return</span> Z_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Decompress from file source to file dest until stream ends or EOF.</span></span><br><span class="line"><span class="comment">   inf() returns Z_OK on success, Z_MEM_ERROR if memory could not be</span></span><br><span class="line"><span class="comment">   allocated for processing, Z_DATA_ERROR if the deflate data is</span></span><br><span class="line"><span class="comment">   invalid or incomplete, Z_VERSION_ERROR if the version of zlib.h and</span></span><br><span class="line"><span class="comment">   the version of the library linked do not match, or Z_ERRNO if there</span></span><br><span class="line"><span class="comment">   is an error reading or writing the files. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inf</span><span class="params">(FILE *source, FILE *dest)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">unsigned</span> have;</span><br><span class="line">    z_stream strm;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> in[CHUNK];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> out[CHUNK];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* allocate inflate state */</span></span><br><span class="line">    strm.zalloc = Z_NULL;</span><br><span class="line">    strm.zfree = Z_NULL;</span><br><span class="line">    strm.opaque = Z_NULL;</span><br><span class="line">    strm.avail_in = <span class="number">0</span>;</span><br><span class="line">    strm.next_in = Z_NULL;</span><br><span class="line">    ret = inflateInit(&amp;strm);</span><br><span class="line">    <span class="keyword">if</span> (ret != Z_OK)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* decompress until deflate stream ends or end of file */</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        strm.avail_in = fread(in, <span class="number">1</span>, CHUNK, source);</span><br><span class="line">        <span class="keyword">if</span> (ferror(source)) &#123;</span><br><span class="line">            (<span class="keyword">void</span>)inflateEnd(&amp;strm);</span><br><span class="line">            <span class="keyword">return</span> Z_ERRNO;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (strm.avail_in == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        strm.next_in = in;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* run inflate() on input until output buffer not full */</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            strm.avail_out = CHUNK;</span><br><span class="line">            strm.next_out = out;</span><br><span class="line">            ret = inflate(&amp;strm, Z_NO_FLUSH);</span><br><span class="line">            assert(ret != Z_STREAM_ERROR);  <span class="comment">/* state not clobbered */</span></span><br><span class="line">            <span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">            <span class="keyword">case</span> Z_NEED_DICT:</span><br><span class="line">                ret = Z_DATA_ERROR;     <span class="comment">/* and fall through */</span></span><br><span class="line">            <span class="keyword">case</span> Z_DATA_ERROR:</span><br><span class="line">            <span class="keyword">case</span> Z_MEM_ERROR:</span><br><span class="line">                (<span class="keyword">void</span>)inflateEnd(&amp;strm);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line">            have = CHUNK - strm.avail_out;</span><br><span class="line">            <span class="keyword">if</span> (fwrite(out, <span class="number">1</span>, have, dest) != have || ferror(dest)) &#123;</span><br><span class="line">                (<span class="keyword">void</span>)inflateEnd(&amp;strm);</span><br><span class="line">                <span class="keyword">return</span> Z_ERRNO;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (strm.avail_out == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* done when inflate() says it's done */</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (ret != Z_STREAM_END);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* clean up and return */</span></span><br><span class="line">    (<span class="keyword">void</span>)inflateEnd(&amp;strm);</span><br><span class="line">    <span class="keyword">return</span> ret == Z_STREAM_END ? Z_OK : Z_DATA_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* report a zlib or i/o error */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zerr</span><span class="params">(<span class="keyword">int</span> ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">"zpipe: "</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">    <span class="keyword">case</span> Z_ERRNO:</span><br><span class="line">        <span class="keyword">if</span> (ferror(<span class="built_in">stdin</span>))</span><br><span class="line">            <span class="built_in">fputs</span>(<span class="string">"error reading stdin\n"</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="keyword">if</span> (ferror(<span class="built_in">stdout</span>))</span><br><span class="line">            <span class="built_in">fputs</span>(<span class="string">"error writing stdout\n"</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Z_STREAM_ERROR:</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"invalid compression level\n"</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Z_DATA_ERROR:</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"invalid or incomplete deflate data\n"</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Z_MEM_ERROR:</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"out of memory\n"</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Z_VERSION_ERROR:</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"zlib version mismatch!\n"</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* compress or decompress from stdin to stdout */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* avoid end-of-line conversions */</span></span><br><span class="line">    SET_BINARY_MODE(<span class="built_in">stdin</span>);</span><br><span class="line">    SET_BINARY_MODE(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* do compression if no arguments */</span></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span>) &#123;</span><br><span class="line">        ret = def(<span class="built_in">stdin</span>, <span class="built_in">stdout</span>, Z_DEFAULT_COMPRESSION);</span><br><span class="line">        <span class="keyword">if</span> (ret != Z_OK)</span><br><span class="line">            zerr(ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* do decompression if -d specified */</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argc == <span class="number">2</span> &amp;&amp; <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-d"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        ret = inf(<span class="built_in">stdin</span>, <span class="built_in">stdout</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret != Z_OK)</span><br><span class="line">            zerr(ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* otherwise, report usage */</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"zpipe usage: zpipe [-d] &lt; source &gt; dest\n"</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个程序的输入是文件名，作用是输入的文件压缩成压缩文件或者是将压缩文件解压。根据输入参数的不同，相应地调到def函数或是inf函数，分别代表压缩和解压。def函数和inf函数的输入输出均是文件指针。</p>
<p><strong>压缩的过程如下：</strong></p>
<ol>
<li><p>z_stream保存了当前压缩的上下文状态。压缩的过程首先对z_stream进行初始化，设置压缩等级，其中的几个函数等。</p>
</li>
<li><p>用一个大循环从输入文件中最多读出CHUNK字节的数据到in这个buffer中。</p>
</li>
<li><p>判断文件是否已经到最后了，以判断是否需要进行flush操作。</p>
</li>
<li><p>设置z_stream的next_in为in这个buffer，设置z_stream的avail_in为从文件读到in中的字节数。</p>
</li>
<li><p>然后设置z_stream的avail_out为CHUNK，next_out为out这个buffer。</p>
</li>
<li><p>然后对z_stream调用deflate，如果已经到了文件的结尾，需要告诉deflate函数。</p>
</li>
<li><p>计算出本次deflate操作产出的数据量，<code>have = CHUNK - strm.avail_out;</code>。</p>
</li>
<li><p>将本次操作产出的压缩数据写到压缩文件中。</p>
</li>
<li><p>内部这个while循环有些不好理解：</p>
<ol>
<li>deflate这个函数完成后会更新z_stream中的avail_out, next_out。我们要保证next_out有空间给我们来输出，也就是avail_out不为0。如果输出空间不够了，deflate会停止压缩。</li>
<li>Z_NO_FLUSH这个标志使deflate可能不会完全将输入一一对应地压缩出来，deflate中会有一些残留的输入还没有输出。这样做是为了提高压缩率。</li>
<li>由于2中的特征，一次deflate可能不能将输入next_in压缩完，因为输出buffer满了。这种情况下我们要判断输出buffer是否已经满了，即avail_out为0。如果是的话，就要重复循环中的过程，确保输入被压缩完。</li>
</ol>
</li>
<li><p>如果到了文件的结尾，对deflate的调用有Z_FINISH这个标志，使deflate将数据完全压缩后输出到文件。</p>
</li>
</ol>
<p>解压过程和压缩过程区别在于deflate被换成了inflate，过程和压缩过程完全一样。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengzipei.github.io/2018/05/30/configure-transparent-proxy-with-router/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zipei Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zipei Feng's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/configure-transparent-proxy-with-router/" itemprop="url">configure transparent proxy with router</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-30T19:31:00+08:00">
                2018-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Configure-transparent-proxy-with-router"><a href="#Configure-transparent-proxy-with-router" class="headerlink" title="Configure transparent proxy with router"></a>Configure transparent proxy with router</h1><blockquote>
<p>Environment:</p>
<p>Router: ASUS ac66u_b1</p>
<p>OS: asus merlin 384.3</p>
<p>Shadowsocks: shadowsocks-libev 3.1(support udp relay)</p>
</blockquote>
<ol>
<li><p>Install shadowsocks-libev on VPS, start ss-server with udp relay enabled <code>-u</code>.</p>
</li>
<li><p>Install ss-redir on router(need to install entware first).</p>
</li>
<li><p>Start ss-redir on router with <code>-u</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ss-redir -s [VPS<span class="string">'s ipv6 address] -p [shadowsocks'</span>s port] -m [encrypt method] -k [password] -b 0.0.0.0 -l 1080 -u &gt; /dev/null &amp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Enable TPROXY on router:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">modprobe ip_set</span><br><span class="line">modprobe ip_set_hash_net</span><br><span class="line">modprobe ip_set_hash_ip</span><br><span class="line">modprobe xt_set</span><br><span class="line">modprobe xt_TPROXY.ko</span><br></pre></td></tr></table></figure>
</li>
<li><p>Configure iptables:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TCP rules</span></span><br><span class="line">iptables -t nat -N SHADOWSOCKS_TCP</span><br><span class="line">iptables -t nat -A SHADOWSOCKS -d [VPS<span class="string">'s ipv4 address] -j RETURN</span></span><br><span class="line"><span class="string">iptables -t nat -A SHADOWSOCKS_TCP -d 0.0.0.0/8 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t nat -A SHADOWSOCKS_TCP -d 10.0.0.0/8 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t nat -A SHADOWSOCKS_TCP -d 127.0.0.0/8 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t nat -A SHADOWSOCKS_TCP -d 169.254.0.0/16 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t nat -A SHADOWSOCKS_TCP -d 172.16.0.0/12 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t nat -A SHADOWSOCKS_TCP -d 192.168.0.0/16 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t nat -A SHADOWSOCKS_TCP -d 224.0.0.0/4 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t nat -A SHADOWSOCKS_TCP -d 240.0.0.0/4 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t nat -A SHADOWSOCKS_TCP -p tcp -j REDIRECT --to-ports 1080</span></span><br><span class="line"><span class="string">iptables -t nat -I PREROUTING 1 -p tcp -j SHADOWSOCKS_TCP</span></span><br><span class="line"><span class="string">iptables -t nat -I OUTPUT 1 -p tcp -j SHADOWSOCKS_TCP</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># UDP rules</span></span><br><span class="line"><span class="string">iptables -t mangle -N SHADOWSOCKS_UDP</span></span><br><span class="line"><span class="string">iptables -t mangle -N SHADOWSOCKS_MARK</span></span><br><span class="line"><span class="string">ip rule add fwmark 1 lookup 100</span></span><br><span class="line"><span class="string">ip route add local default dev lo table 100</span></span><br><span class="line"><span class="string">iptables -t nat -A SHADOWSOCKS_MARK -d [VPS'</span>s ipv4 address] -j RETURN</span><br><span class="line">iptables -t mangle -A SHADOWSOCKS_MARK -d 0.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t mangle -A SHADOWSOCKS_MARK -d 10.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t mangle -A SHADOWSOCKS_MARK -d 127.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t mangle -A SHADOWSOCKS_MARK -d 169.254.0.0/16 -j RETURN</span><br><span class="line">iptables -t mangle -A SHADOWSOCKS_MARK -d 172.16.0.0/12 -j RETURN</span><br><span class="line">iptables -t mangle -A SHADOWSOCKS_MARK -d 192.168.0.0/16 -j RETURN</span><br><span class="line">iptables -t mangle -A SHADOWSOCKS_MARK -d 224.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t mangle -A SHADOWSOCKS_MARK -d 240.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t nat -A SHADOWSOCKS_UDP -d [VPS<span class="string">'s ipv4 address] -j RETURN</span></span><br><span class="line"><span class="string">iptables -t mangle -A SHADOWSOCKS_UDP -d 0.0.0.0/8 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t mangle -A SHADOWSOCKS_UDP -d 10.0.0.0/8 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t mangle -A SHADOWSOCKS_UDP -d 127.0.0.0/8 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t mangle -A SHADOWSOCKS_UDP -d 169.254.0.0/16 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t mangle -A SHADOWSOCKS_UDP -d 172.16.0.0/12 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t mangle -A SHADOWSOCKS_UDP -d 192.168.0.0/16 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t mangle -A SHADOWSOCKS_UDP -d 224.0.0.0/4 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t mangle -A SHADOWSOCKS_UDP -d 240.0.0.0/4 -j RETURN</span></span><br><span class="line"><span class="string">iptables -t mangle -A SHADOWSOCKS_MARK -p udp -d 8.8.8.8 --dport 53 -j MARK --set-mark 1</span></span><br><span class="line"><span class="string">iptables -t mangle -A SHADOWSOCKS_UDP -p udp --dport 53 -j TPROXY --on-port 1080 --on-ip 192.168.50.1 --tproxy-mark 0x01/0x01</span></span><br><span class="line"><span class="string">iptables -t mangle -A PREROUTING -p udp -j SHADOWSOCKS_UDP</span></span><br><span class="line"><span class="string">iptables -t mangle -A OUTPUT -p udp -j SHADOWSOCKS_MARK</span></span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengzipei.github.io/2018/05/30/enable-bbr-on-Ubuntu-16-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zipei Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zipei Feng's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/enable-bbr-on-Ubuntu-16-04/" itemprop="url">enable bbr on Ubuntu 16.04</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-30T19:28:03+08:00">
                2018-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Enable-bbr-on-Ubuntu-16-04"><a href="#Enable-bbr-on-Ubuntu-16-04" class="headerlink" title="Enable bbr on Ubuntu 16.04"></a>Enable bbr on Ubuntu 16.04</h1><ol>
<li><p>Make sure kernel version is 4.9 or newer:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -r</span><br></pre></td></tr></table></figure>
<p>Install Hardware Enablement Stack (HWE) to update kernel automaticly:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install --install-recommends linux-generic-hwe-16.04</span><br></pre></td></tr></table></figure>
</li>
<li><p>Enable bbr:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo modprobe tcp_bbr</span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"tcp_bbr"</span> &gt;&gt; /etc/modules-load.d/modules.conf</span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"net.core.default_qdisc=fq"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"net.ipv4.tcp_congestion_control=bbr"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure>
</li>
<li><p>Check if bbr is enabled:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl net.ipv4.tcp_available_congestion_control</span><br><span class="line">sudo sysctl net.ipv4.tcp_congestion_control</span><br><span class="line">lsmod | grep bbr</span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengzipei.github.io/2018/05/30/add-system-call-to-kernel-4-x/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zipei Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zipei Feng's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/add-system-call-to-kernel-4-x/" itemprop="url">add system call to kernel 4.x</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-30T19:22:04+08:00">
                2018-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Add-a-new-entry-in-syscall-table"><a href="#Add-a-new-entry-in-syscall-table" class="headerlink" title="Add a new entry in syscall table"></a>Add a new entry in syscall table</h2><blockquote>
<p>OS: Ubuntu 16.04 64 bit</p>
</blockquote>
<p>Add a entry in <code>arch/x86/entry/syscalls/syscall_64.tbl</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">322</span>     <span class="number">64</span>      execveat                stub_execveat</span><br><span class="line"><span class="number">323</span>     common  userfaultfd             sys_userfaultfd</span><br><span class="line"><span class="number">324</span>     common  membarrier              sys_membarrier</span><br><span class="line"><span class="number">325</span>     common  mlock2                  sys_mlock2</span><br><span class="line"><span class="number">326</span>     common  hello                   sys_hello      &lt;---- 加在这一行</span><br></pre></td></tr></table></figure>
<h2 id="Declare-the-system-call"><a href="#Declare-the-system-call" class="headerlink" title="Declare the system call"></a>Declare the system call</h2><p>Add a declaration to our system call in <code>include/linux/syscalls.h</code>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">asmlinkage <span class="keyword">long</span> <span class="title">sys_membarrier</span><span class="params">(<span class="keyword">int</span> cmd, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">asmlinkage <span class="keyword">long</span> <span class="title">sys_mlock2</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> start, <span class="keyword">size_t</span> len, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">asmlinkage <span class="keyword">long</span> <span class="title">sys_hello</span><span class="params">(<span class="keyword">void</span>)</span></span>;  &lt;---- 加这一行</span><br></pre></td></tr></table></figure></p>
<h2 id="Implement-our-system-call"><a href="#Implement-our-system-call" class="headerlink" title="Implement our system call"></a>Implement our system call</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir hello</span><br><span class="line">touch hello/hello.c</span><br><span class="line">touch hello/Makefile</span><br></pre></td></tr></table></figure>
<p>Content in hello/hello.c:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">asmlinkage <span class="keyword">long</span> <span class="title">sys_hello</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">"Hello world\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Content in hello/Makefile:<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-y := hello.o</span><br></pre></td></tr></table></figure></p>
<h2 id="Modifiy-Makefile-in-linux-4-x"><a href="#Modifiy-Makefile-in-linux-4-x" class="headerlink" title="Modifiy Makefile in linux-4.x/"></a>Modifiy <code>Makefile</code> in linux-4.x/</h2><p>Change<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">core-y          += kernel/ certs/ mm/ fs/ ipc/ security/ crypto/ block/</span><br></pre></td></tr></table></figure></p>
<p>to<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">core-y          += kernel/ certs/ mm/ fs/ ipc/ security/ crypto/ block/ hello/</span><br></pre></td></tr></table></figure></p>
<h2 id="Compile-kernel"><a href="#Compile-kernel" class="headerlink" title="Compile kernel"></a>Compile kernel</h2><ol>
<li><code>make menuconfig</code></li>
<li><code>make -j$(nproc)</code></li>
<li><code>sudo make modules_install</code></li>
<li><code>sudo make install</code></li>
<li><code>sudo reboot</code></li>
</ol>
<h2 id="Write-program-to-use-the-system-call"><a href="#Write-program-to-use-the-system-call" class="headerlink" title="Write program to use the system call"></a>Write program to use the system call</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_hello 326</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">hello_syscall</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_hello);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> a = hello_syscall();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"System call returned %ld\n"</span>, a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If everything is OK, we can see “Hello world” in <code>dmesg</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengzipei.github.io/2018/05/30/run-crail-on-Ubuntu-16-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zipei Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zipei Feng's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/run-crail-on-Ubuntu-16-04/" itemprop="url">run crail on Ubuntu 16.04</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-30T19:20:20+08:00">
                2018-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Run-crail-on-Ubuntu-16-04"><a href="#Run-crail-on-Ubuntu-16-04" class="headerlink" title="Run crail on Ubuntu 16.04"></a>Run crail on Ubuntu 16.04</h1><ol>
<li><p>Set HugePages_Total:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c <span class="string">"echo 81920 &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages"</span></span><br></pre></td></tr></table></figure>
<p>Verify it by <code>cat /proc/meminfo</code>.</p>
</li>
<li><p>Mount hugetlbfs:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t tmpfs -o size=10g tmpfs /media/crail</span><br></pre></td></tr></table></figure>
</li>
<li><p>Set up index path’s mount point.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t hugetlbfs none /mnt</span><br></pre></td></tr></table></figure>
</li>
<li><p>Set up CRAIL_HOME.</p>
</li>
<li><p>Change mount point’s owner:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R hadoop:hadoop /mnt</span><br><span class="line">sudo chown -R hadoop:hadoop /media/crail</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run crail’s namenode &amp; datanode.</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengzipei.github.io/2018/05/30/compile-hadoop-2-8-on-Ubuntu-16-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zipei Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zipei Feng's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/compile-hadoop-2-8-on-Ubuntu-16-04/" itemprop="url">compile hadoop 2.8 on Ubuntu 16.04</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-30T19:18:26+08:00">
                2018-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Compile-hadoop-2-8-on-Ubuntu-16-04"><a href="#Compile-hadoop-2-8-on-Ubuntu-16-04" class="headerlink" title="Compile hadoop 2.8 on Ubuntu 16.04"></a>Compile hadoop 2.8 on Ubuntu 16.04</h1><ol>
<li><p>Install some dependencies:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo apt -y install gcc*</span><br><span class="line">sudo apt -y install cmake</span><br><span class="line">sudo apt -y install glibc-headers</span><br><span class="line">sudo apt -y install gcc-c++</span><br><span class="line">sudo apt -y install zip-devel</span><br><span class="line">sudo apt -y install openssl-devel</span><br><span class="line">sudo apt -y install svn</span><br><span class="line">sudo apt -y install git</span><br><span class="line">sudo apt -y install ncurses-devel</span><br><span class="line">sudo apt -y install lzo-devel</span><br><span class="line">sudo apt -y install autoconf</span><br><span class="line">sudo apt -y install libtool</span><br><span class="line">sudo apt -y install automake</span><br></pre></td></tr></table></figure>
</li>
<li><p>Install protobuf:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/google/protobuf/releases/download/v2.5.0/protobuf-2.5.0.tar.gz</span><br><span class="line">tar zxvf protobuf-2.5.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> protobuf-2.5.0</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make check</span><br><span class="line">sudo make install</span><br><span class="line">sudo ldconfig</span><br></pre></td></tr></table></figure>
</li>
<li><p>Compile Hadoop:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://apache.spinellicreations.com/hadoop/common/hadoop-2.8.1/hadoop-2.8.1-src.tar.gz</span><br><span class="line">tar -zxvf hadoop-2.8.1-src.tar.gz</span><br><span class="line"><span class="built_in">cd</span> hadoop-2.8.1-src</span><br><span class="line">mvn package -Dmaven.javadoc.skip=<span class="literal">true</span> -Pdist,native -DskipTests -Dtar</span><br></pre></td></tr></table></figure>
</li>
<li><p>The compiled hadoop tarball locates at <code>hadoop-2.8.1-src/hadoop-dist/target/hadoop-2.8.1.tar.gz</code></p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengzipei.github.io/2018/05/30/compile-kernel-4-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zipei Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zipei Feng's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/compile-kernel-4-4/" itemprop="url">compile kernel 4.4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-30T19:05:57+08:00">
                2018-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Some-dependencies-to-install-before-compilation"><a href="#Some-dependencies-to-install-before-compilation" class="headerlink" title="Some dependencies to install before compilation:"></a>Some dependencies to install before compilation:</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libncurses5-dev libncursesw5-dev libssl-dev</span><br></pre></td></tr></table></figure>
<h2 id="Compile-kernel"><a href="#Compile-kernel" class="headerlink" title="Compile kernel"></a>Compile kernel</h2><ol>
<li><code>make menuconfig</code></li>
<li><code>make -j$(nproc)</code></li>
<li><code>sudo make modules_install</code></li>
<li><code>sudo make install</code></li>
<li><code>sudo reboot</code></li>
</ol>
<h2 id="Solution-to-PIC-Mode-related-error"><a href="#Solution-to-PIC-Mode-related-error" class="headerlink" title="Solution to PIC Mode related error:"></a>Solution to PIC Mode related error:</h2><p>Add these lines after ‘all: vmlinux’ in Makefile:<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">KBUILD_CFLAGS += <span class="variable">$(<span class="built_in">call</span> cc-option, -fno-pie)</span></span><br><span class="line">KBUILD_CFLAGS += <span class="variable">$(<span class="built_in">call</span> cc-option, -no-pie)</span></span><br><span class="line">KBUILD_AFLAGS += <span class="variable">$(<span class="built_in">call</span> cc-option, -fno-pie)</span></span><br><span class="line">KBUILD_CPPFLAGS += <span class="variable">$(<span class="built_in">call</span> cc-option, -fno-pie)</span></span><br></pre></td></tr></table></figure></p>
<p>That is,</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--- a/Makefile</span><br><span class="line">+++ b/Makefile</span><br><span class="line">@@ -608,6 +608,12 @@ <span class="keyword">endif</span> <span class="comment"># $(dot-config)</span></span><br><span class="line"> <span class="comment"># Defaults to vmlinux, but the arch makefile usually adds further targets</span></span><br><span class="line"> all: vmlinux</span><br><span class="line"></span><br><span class="line">+<span class="comment"># force no-pie for distro compilers that enable pie by default</span></span><br><span class="line">+KBUILD_CFLAGS += <span class="variable">$(<span class="built_in">call</span> cc-option, -fno-pie)</span></span><br><span class="line">+KBUILD_CFLAGS += <span class="variable">$(<span class="built_in">call</span> cc-option, -no-pie)</span></span><br><span class="line">+KBUILD_AFLAGS += <span class="variable">$(<span class="built_in">call</span> cc-option, -fno-pie)</span></span><br><span class="line">+KBUILD_CPPFLAGS += <span class="variable">$(<span class="built_in">call</span> cc-option, -fno-pie)</span></span><br><span class="line">+</span><br><span class="line"> <span class="comment"># The arch Makefile can set ARCH_&#123;CPP,A,C&#125;FLAGS to override the default</span></span><br><span class="line"> <span class="comment"># values of the respective KBUILD_* variables</span></span><br><span class="line"> ARCH_CPPFLAGS :=</span><br><span class="line">--</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zipei Feng</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zipei Feng</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
